"use strict";var m=require("fs"),h=require("istanbul-lib-report");function p(n){return n.statements.pct===100&&n.branches.pct===100&&n.functions.pct===100&&n.lines.pct===100}function f(n){if(n.isSummary())return[];let e=n.getCoverageSummary(!1),t=e.isEmpty()?0:e.lines.pct,r,l=n.getFileCoverage();if(t===100){let i=l.getBranchCoverageByLine();r=Object.entries(i).map(([a,{coverage:c}])=>[a,c===100])}else r=Object.entries(l.getLineCoverage());let o=!0;return r.reduce((i,[a,c])=>{if(c)o=!0;else{let u=parseInt(a);o?(i.push([u]),o=!1):i[i.length-1][1]=u}return i},[])}var d=["Statements","Branches","Functions","Lines"];module.exports=class extends h.ReportBase{skipEmpty;skipFull;results={};cw=null;watermarks={};constructor(e){super(e),this.skipEmpty=!!e.skipEmpty,this.skipFull=!!e.skipFull}onStart(e,s){if(!process.env.GITHUB_STEP_SUMMARY){console.log("Reporter not being executed in Github Actions environment");return}this.cw=m.createWriteStream(process.env.GITHUB_STEP_SUMMARY,{encoding:"utf-8",flags:"a"}),this.watermarks=s.watermarks,this.cw.write("<h2>Test Coverage</h2>"),this.cw.write("<table><thead><tr>");for(let t of["File",...d,"Uncovered Lines"])this.cw.write(`<th>${t}</th>`);this.cw.write("</tr></thead><tbody>")}onSummary(e){let s=e.getRelativeName()||"All Files",t=e.getCoverageSummary(!1),r=t.isEmpty();this.skipEmpty&&r||this.skipFull&&p(t)||(this.results[s]={statements:r?0:t.statements.pct,branches:r?0:t.branches.pct,functions:r?0:t.functions.pct,lines:r?0:t.lines.pct,uncoveredLines:f(e)})}onDetail(e){return this.onSummary(e)}formatter(e,s){if(this.watermarks[s]===void 0)return`<td>${e}%</td>`;let[t,r]=this.watermarks[s];return e<t?`<td><p style="color:red">${e}%</p></td>`:e>r?`<td><p style="color:green">${e}%</p></td>`:`<td><p style="color:yellow">${e}%</p></td>`}onEnd(){if(!this.cw)return;let e=Object.keys(this.results).sort();for(let s of e){let t=this.results[s];if(this.cw.write(`<tr><td><code>${s}</code></td>`),this.cw.write(this.formatter(t.statements,"statements")),this.cw.write(this.formatter(t.branches,"branches")),this.cw.write(this.formatter(t.functions,"functions")),this.cw.write(this.formatter(t.lines,"lines")),t.uncoveredLines.length>0){this.cw.write("<td><details><summary>Expand</summary><ul>");for(let r of t.uncoveredLines)r.length===1?this.cw.write(`<li>${r[0]}</li>`):this.cw.write(`<li>${r[0]}-${r[1]}</li>`);this.cw.write("</ul></details></td>")}else this.cw.write("<td></td>");this.cw.write("</tr>")}this.cw.write("</tbody></table>"),this.cw.close()}};
