import{_ as i,c as t,o as a,a2 as e}from"./chunks/framework.BYVJ-AET.js";const c=JSON.parse('{"title":"General Design of the Build Tools","description":"","frontmatter":{},"headers":[],"relativePath":"buildtools/3-structure.md","filePath":"buildtools/3-structure.md","lastUpdated":1762843456000}'),n={name:"buildtools/3-structure.md"};function h(l,s,p,o,r,d){return a(),t("div",null,s[0]||(s[0]=[e(`<h1 id="general-design-of-the-build-tools" tabindex="-1">General Design of the Build Tools <a class="header-anchor" href="#general-design-of-the-build-tools" aria-label="Permalink to &quot;General Design of the Build Tools&quot;">​</a></h1><h2 id="path-resolution" tabindex="-1">Path Resolution <a class="header-anchor" href="#path-resolution" aria-label="Permalink to &quot;Path Resolution&quot;">​</a></h2><p>The build tools are designed to be written in Typescript, then compiled and bundled by <code>esbuild</code> into a single minified Javascript file <code>dist/index.js</code>. This means relative paths used during runtime need to be written in such a way that they account for the path of the executable file.</p><p>For example, the template script needs to copy the templates from the <code>dist/templates</code> folder. So the call to <code>fs.cp</code> is written relative to <code>import.meta.dirname</code> instead of hardcoding a relative path:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// lib/buildtools/src/templates/bundle.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`\${</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">meta</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dirname</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}/templates/bundle\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, bundleDestination, { recursive: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span></code></pre></div><p>When <code>dist/index.js</code> is executed, <code>import.meta.dirname</code> refers to <code>lib/buildtools/dist</code>, so the above path becomes <code>lib/buildtools/dist/templates/bundle</code>, which is the actual location of where the template files are located.</p><p>On the other hand, relative module imports that are bundled during the compilation process don&#39;t need to be changed. The template script imports the root package json to determine the versions of dependencies to use:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// lib/buildtools/src/templates/bundle.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _package </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;../../../../package.json&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;json&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// extract typescript version</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">typescript</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">typescriptVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _package;</span></span></code></pre></div><p>Although the resolved module path refers to a path outside of the buildtools folder, during compilation, <code>esbuild</code> actually embeds the entire JSON file into <code>dist/index.js</code>, thus removing the import altogether:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ../../package.json</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> package_default </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  private: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;@sourceacademy/modules&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  version: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;1.0.0&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  repository: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://github.com/source-academy/modules.git&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  license: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Apache-2.0&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // other things...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> typescriptVersion</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> package_default.devDependencies.typescript;</span></span></code></pre></div><h2 id="sourceacademy-modules-repotools-getgitroot-ts" tabindex="-1"><code>@sourceacademy/modules-repotools/getGitRoot.ts</code> <a class="header-anchor" href="#sourceacademy-modules-repotools-getgitroot-ts" aria-label="Permalink to &quot;\`@sourceacademy/modules-repotools/getGitRoot.ts\`&quot;">​</a></h2><p>In general, the outputs of compiling bundles and tabs are placed relative to the root of the Git repository (the <code>/build</code>) folder. Since the buildtools need to be able to be executed from any of the bundles&#39; and tabs&#39; directories and subdirectories (and in fact any directory within the repository), it is crucial that the build tools are able to obtain a path to the root of the repository.</p><p>The path to the root of the repository can be obtained by running the Git command:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rev-parse</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --show-toplevel</span></span></code></pre></div><p>To get run this command from NodeJS and get the output of this command programmatically, we use <a href="https://nodejs.org/api/child_process.html#child_processexecfilefile-args-options-callback" target="_blank" rel="noreferrer"><code>execFile</code></a> from NodeJS&#39;s <code>child_process</code> library:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> rawGetGitRoot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">reject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    execFile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;git&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;rev-parse&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;--show-toplevel&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stdout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stderr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> possibleError</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stderr;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (possibleError) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        reject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(possibleError);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(stdout.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trim</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>This is guaranteed to work, since the user should have Git present on their system (otherwise how did they get this git repo?)</p><p>You can import the absolute file paths to different directories straight from this module:</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { bundlesDir, tabsDir, outDir } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@sourceacademy/modules-repotools/getGitRoot&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bundlesDir);</span></span></code></pre></div><p>By abstracting this functionality into a separate module, it is simple to change the paths at which everything is defined (such as where the directory containing bundles is found). In particular, by mocking this module, we can run the buildtools on mock bundles and tabs with ease.</p><h2 id="the-test-mocks-directory" tabindex="-1">The <code>__test_mocks__</code> Directory <a class="header-anchor" href="#the-test-mocks-directory" aria-label="Permalink to &quot;The \`__test_mocks__\` Directory&quot;">​</a></h2><p>This directory contains 2 mock bundles and 2 mock tabs, intended for testing the output of the buildtools. In <code>__mocks__</code>, there is a mock implementation of <code>getGitRoot.ts</code> that returns file paths relative to this directory instead of the actual Git repository, causing the buildtools to look within this directory for bundles and tabs instead of the actual directories they are located within.</p><h2 id="unit-testing" tabindex="-1">Unit Testing <a class="header-anchor" href="#unit-testing" aria-label="Permalink to &quot;Unit Testing&quot;">​</a></h2><h3 id="test-files" tabindex="-1">Test Files <a class="header-anchor" href="#test-files" aria-label="Permalink to &quot;Test Files&quot;">​</a></h3><p>Only files that match the pattern <code>**/__tests__/**/*.test.ts</code> are considered test files. This allows us to create utility files that are only used for testing purposes, but won&#39;t cause <code>vitest</code> to throw an error because they don&#39;t contain any tests within them.</p><h3 id="global-test-configuration" tabindex="-1">Global Test Configuration <a class="header-anchor" href="#global-test-configuration" aria-label="Permalink to &quot;Global Test Configuration&quot;">​</a></h3><p>The buildtools have a <code>vitest</code> setup file configured to apply some global mocks:</p><ol><li>Mock the <code>fs</code> library&#39;s output functions to make it sure the tests never actually write to the file system</li><li>Mock <code>typescript</code> so that it too does not output any files to the file system, even with <code>noEmit: false</code></li><li>Mock <code>chalk</code> so that the colour formatting characters are removed from console output</li><li>Mock <code>process.exit</code> so that it throws an error that we can catch and observe to assert that it was called</li></ol><p>The setup file also provides two extra matchers that are intended for use with <code>commander</code> commands. The typings for these matchers are included in <code>vitest.d.ts</code>.</p><h2 id="path-manipulation" tabindex="-1">Path Manipulation <a class="header-anchor" href="#path-manipulation" aria-label="Permalink to &quot;Path Manipulation&quot;">​</a></h2><p>The buildtools are designed to work in both Windows and Unix environments. This means that a lot of the path manipulation required (like resolution or concatenation) need to be done in a platform agnostic way where possible. NodeJS provides two versions of its <code>path</code> library: <code>path.win32</code> and <code>path.posix</code> and switches between the versions depending on what it detects the OS to be.</p><p>This is why for the most part, it is preferable to use the <code>path</code> functions rather than string manipulation to manipulate file paths:</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pathlib </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;path&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> finalPath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pathlib.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;3&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// vs</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> finalPath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;1/2/3&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>However, it is important to note that some tooling (like Typedoc) requires Posix style paths. In that case, it becomes necessary to convert all paths to Posix style paths before passing it to Typedoc.</p><p>Many of the unit tests have also been written in this way to account for the different behaviours between Windows and Posix style paths.</p>`,35)]))}const E=i(n,[["render",h]]);export{c as __pageData,E as default};
