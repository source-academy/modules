import{_ as o,c as a,o as t,a2 as s}from"./chunks/framework.BYVJ-AET.js";const u=JSON.parse('{"title":"Yarn","description":"","frontmatter":{},"headers":[],"relativePath":"repotools/5-yarn.md","filePath":"repotools/5-yarn.md","lastUpdated":1770449117000}'),r={name:"repotools/5-yarn.md"};function n(i,e,l,c,d,h){return t(),a("div",null,e[0]||(e[0]=[s('<h1 id="yarn" tabindex="-1">Yarn <a class="header-anchor" href="#yarn" aria-label="Permalink to &quot;Yarn&quot;">​</a></h1><p>This page is dedicated to explaing how Yarn has been configured to work in this repository.</p><h2 id="workspaces" tabindex="-1">Workspaces <a class="header-anchor" href="#workspaces" aria-label="Permalink to &quot;Workspaces&quot;">​</a></h2><p>Yarn, this repository&#39;s package manager, supports a feature called <a href="https://yarnpkg.com/features/workspaces#global-scripts" target="_blank" rel="noreferrer">workspaces</a>, which are a way for packages to refer to one another within the same repository.</p><p>This has several benefits:</p><ul><li><strong>Reduced install size.</strong> Yarn workspaces support focused installs, which means that a single team working on a single bundle or tab won&#39;t have to install the entire repository&#39;s worth of packages that won&#39;t be relevant to them</li><li><strong>Dependency Management.</strong> If tabs (or other bundles) rely on a specific bundle, Yarn&#39;s dependency resolution automatically determines what needs to be rebuilt and in what order.</li><li><strong>Automatic Worktree Detection.</strong> If so desired, Yarn automatically detects which bundles/tabs have changed with respect to the main git branch and won&#39;t rebuild those that haven&#39;t.</li><li><strong>More Configurability:</strong> Each bundle/tab can maintain its own set of dependencies now, separate from other bundles. This allows us to have patches local to a specific bundle (like the <code>@jscad/modeling</code> patch for <code>csg</code>). Also each bundle/tab can customize its own <code>tsconfig</code> etc..</li></ul><p>At the root repository, this is defined using the <code>workspaces</code> field in <code>package.json</code>.</p><h2 id="yarn-constraints" tabindex="-1">Yarn Constraints <a class="header-anchor" href="#yarn-constraints" aria-label="Permalink to &quot;Yarn Constraints&quot;">​</a></h2><p>Yarn also supports a feature known as <a href="https://yarnpkg.com/features/workspaces#constraints" target="_blank" rel="noreferrer">constraints</a> for workspaces. As of this moment, the feature can be used to ensure that all workspaces within a repository have fields in their <code>package.json</code>s set to specific values. We use this feature to ensure that:</p><h3 id="_1-all-workspaces-have-type-module" tabindex="-1">1. All workspaces have <code>&quot;type&quot;: &quot;module&quot;</code> <a class="header-anchor" href="#_1-all-workspaces-have-type-module" aria-label="Permalink to &quot;1. All workspaces have `&quot;type&quot;: &quot;module&quot;`&quot;">​</a></h3><p>As part of ensuring consistency, everything in this repository has been designed to use ESM first and to move away from legacy reliance on CommonJS modules.</p><h3 id="_2-dependencies-if-shared-have-the-correct-versions" tabindex="-1">2. Dependencies, if shared, have the correct versions <a class="header-anchor" href="#_2-dependencies-if-shared-have-the-correct-versions" aria-label="Permalink to &quot;2. Dependencies, if shared, have the correct versions&quot;">​</a></h3><p>Tabs, for example, should all be using the same versions of <code>react</code> and <code>react-dom</code>: the one in use by the frontend. If a dependency is specified in the root <code>package.json</code>, then the constraints file requires that all child workspaces use the version of that dependency.</p><p>For example, the root package specifies <code>react@^18.3.1</code> as a dependency, so all workspaces that require React must also use that version spec.</p><p>This validation is not carried out across child workspaces, however. Two different bundles could use two different versions of the same package. This should not cause an issue <strong>unless</strong> the bundles are somehow dependent on each other.</p><p>Furthermore, if you are depending on a package from within the modules repository, you should be using the <code>workspace:^</code> version specification as the packages within this repository are not intended to be published to NPM so a regular version specification would be invalid.</p><h3 id="_3-js-slang-has-no-resolution-override" tabindex="-1">3. <code>js-slang</code> has no resolution override <a class="header-anchor" href="#_3-js-slang-has-no-resolution-override" aria-label="Permalink to &quot;3. `js-slang` has no resolution override&quot;">​</a></h3><p>Yarn allows users to override the resolution of packages via the <a href="https://yarnpkg.com/configuration/manifest#resolutions" target="_blank" rel="noreferrer"><code>resolutions</code></a> field. There are several reasons to do this, but the most common reason a resolution would be used in this repository would be to point Yarn to a local copy of <code>js-slang</code>.</p><p>Of course, the final production versions of your code shouldn&#39;t be relying on a local copy of <code>js-slang</code> (that wouldn&#39;t exist anyway), so the constraint is enforced here to make sure that <code>js-slang</code> isn&#39;t incorrectly resolved.</p><h3 id="_4-repotools-doesn-t-have-another-local-dependency" tabindex="-1">4. <code>repotools</code> doesn&#39;t have another local dependency <a class="header-anchor" href="#_4-repotools-doesn-t-have-another-local-dependency" aria-label="Permalink to &quot;4. `repotools` doesn&#39;t have another local dependency&quot;">​</a></h3><p>The <code>repotools</code> package is designed to be the &#39;root&#39; for all the tooling in the repository. If it were to depend on another package within this repository, we would create a dependency loop that Yarn would not be able to resolve. So we enforce the constraint that the <code>@sourceacademy/modules-repotools</code> package is not allowed to depend on any other package within this repository.</p><h3 id="_5-vitest-related-dependencies-should-have-the-same-version-as-vitest" tabindex="-1">5. Vitest related dependencies should have the same version as Vitest <a class="header-anchor" href="#_5-vitest-related-dependencies-should-have-the-same-version-as-vitest" aria-label="Permalink to &quot;5. Vitest related dependencies should have the same version as Vitest&quot;">​</a></h3><p>Aside from <code>vitest-browser-react</code> and <code>@vitest/eslint-plugin</code>, all Vitest packages should have the same version range as Vitest throughout the repository.</p><h2 id="parallel-execution-of-scripts" tabindex="-1">Parallel Execution of Scripts <a class="header-anchor" href="#parallel-execution-of-scripts" aria-label="Permalink to &quot;Parallel Execution of Scripts&quot;">​</a></h2><p>Using the various options of the <code>yarn workspaces foreach</code> command, you can execute multiple tasks in parallel, which is how many of the commands in the root repository have been set up.</p><p>The <code>-t</code> option runs the scripts in topological order, which means you don&#39;t have to manually figure out which packages have to be built before others; Yarn figures it out for you.</p><details class="details custom-block"><summary>ESLint out of memory?</summary><p>For some reason when I migrated this repository over to Yarn workspaces, I kept finding that linting all the bundles at once in parallel would cause NodeJS to exceed its default memory limit of 4906MB. I guess if you wanted to run linting for all bundles in parallel you could just run NodeJS with <code>--max-old-space-size</code>, but I just found that limiting the number of jobs running in parallel using <code>-j</code> to 5 was sufficient to get around this issue.</p></details>',27)]))}const f=o(r,[["render",n]]);export{u as __pageData,f as default};
