import{_ as n,C as t,c as l,o as i,a2 as h,b as p,w as a,a as r,G as d,a3 as o}from"./chunks/framework.BYVJ-AET.js";const f=JSON.parse('{"title":"Building for Bundles and Tabs","description":"","frontmatter":{},"headers":[],"relativePath":"buildtools/5-builders/1-modules.md","filePath":"buildtools/5-builders/1-modules.md","lastUpdated":1768309297000}'),k={name:"buildtools/5-builders/1-modules.md"};function c(u,s,E,g,b,y){const e=t("Mermaid");return i(),l("div",null,[s[1]||(s[1]=h(`<h1 id="building-for-bundles-and-tabs" tabindex="-1">Building for Bundles and Tabs <a class="header-anchor" href="#building-for-bundles-and-tabs" aria-label="Permalink to &quot;Building for Bundles and Tabs&quot;">​</a></h1><h2 id="why-bundle" tabindex="-1">Why Bundle? <a class="header-anchor" href="#why-bundle" aria-label="Permalink to &quot;Why Bundle?&quot;">​</a></h2><p>To run module code, <code>js-slang</code> would have to have all the dependencies of every single module, which would make building it tedious and bloated and also introduce an undesirable dependency between modules and js-slang. Instead, Source Modules are bundled before use.</p><p>Bundling refers to the process of combining all of a module&#39;s dependencies into a single file. You can refer to <a href="https://nextjs.org/learn/foundations/how-nextjs-works/bundling" target="_blank" rel="noreferrer">other projects</a> that require bundling for more information.<br> Dependencies available at runtime aren&#39;t bundled and are handled differently (refer to later sections for more information)</p><h2 id="bundlers" tabindex="-1">Bundlers <a class="header-anchor" href="#bundlers" aria-label="Permalink to &quot;Bundlers&quot;">​</a></h2><p>Currently, there are several bundlers available such as RollupJS, Babel and Webpack. These bundlers trade speed for high configurability, giving the user a wide range of configuration options and plugins to customize the bundling process. Most of these options are unnecessary for bundling source modules.<br><a href="https://esbuild.github.io" target="_blank" rel="noreferrer"><code>esbuild</code></a> is a Javascript bundler that trades configurability for speed. It is magnitudes faster than most other bundlers and suits the modules repository just fine. We use it to transpile module code from Typescript to Javascript and perform bundling.</p><h2 id="how-source-modules-are-bundled" tabindex="-1">How Source Modules are Bundled <a class="header-anchor" href="#how-source-modules-are-bundled" aria-label="Permalink to &quot;How Source Modules are Bundled&quot;">​</a></h2><p>Bundles and tabs are transpiled with esbuild. This converts each bundle and tab into an <a href="https://developer.mozilla.org/en-US/docs/Glossary/IIFE" target="_blank" rel="noreferrer">IIFE</a>. Here is the <code>curve</code> bundle passed through <code>esbuild</code>:</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// All of the code within the curve bundle is combined into a single file</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// build/bundles/curve.js</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> globalName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Code from mat4</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* implementation details */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> clone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* implementation details */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> copy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">out</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* implementation details */</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ... and other implementation details</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // The module&#39;s exports are returned as a single object</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    draw_connected_2d,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    make_point,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // etc...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})();</span></span></code></pre></div><h2 id="options-explained" tabindex="-1">Options Explained <a class="header-anchor" href="#options-explained" aria-label="Permalink to &quot;Options Explained&quot;">​</a></h2><h3 id="bundle-true" tabindex="-1"><code>bundle: true</code> <a class="header-anchor" href="#bundle-true" aria-label="Permalink to &quot;\`bundle: true\`&quot;">​</a></h3><p>Tell <code>esbuild</code> to bundle the code into a single file.</p><h3 id="external" tabindex="-1"><code>external</code> <a class="header-anchor" href="#external" aria-label="Permalink to &quot;\`external\`&quot;">​</a></h3><p>This option is used to mark which packages not to include when bundling. This is useful for dependencies that are available at runtime (e.g The Frontend provides React).</p><h3 id="format-iife" tabindex="-1"><code>format: &#39;iife&#39;</code> <a class="header-anchor" href="#format-iife" aria-label="Permalink to &quot;\`format: &#39;iife&#39;\`&quot;">​</a></h3><p>Tell <code>esbuild</code> to output the code as an <a href="https://developer.mozilla.org/en-US/docs/Glossary/IIFE" target="_blank" rel="noreferrer">IIFE</a>.</p><h3 id="globalname-module" tabindex="-1"><code>globalName: &#39;module&#39;</code> <a class="header-anchor" href="#globalname-module" aria-label="Permalink to &quot;\`globalName: &#39;module&#39;\`&quot;">​</a></h3><p>By default, <code>esbuild</code>&#39;s IIFE output doesn&#39;t return its exports:</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exports </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {};</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  exports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add_one</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})();</span></span></code></pre></div><p>By specifying a <code>globalName</code>, the generated code instead becomes:</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> module </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exports </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {};</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  exports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add_one</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> exports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})();</span></span></code></pre></div><p>It is then possible to extract the inner IIFE and use it to retrieve the exports.</p><h3 id="define" tabindex="-1"><code>define</code> <a class="header-anchor" href="#define" aria-label="Permalink to &quot;\`define\`&quot;">​</a></h3><p>Module code that requires constructs such as <code>process.env</code> which are unavailable in the browser environment will cause the Source program to crash.</p><p>The <code>define</code> option tells esbuild to replace instances with <code>process.env</code> with <code>{ NODE_ENV; &#39;production&#39; }</code>, making that environment variable available at runtime</p><p>Similarly, because we are bundling for the browser, it becomes necessary to define the NodeJS <code>global</code> as the browser <code>globalThis</code>.</p><h3 id="platform-browser-target-es6" tabindex="-1"><code>platform: &#39;browser</code>, <code>target: &#39;es6&#39;</code> <a class="header-anchor" href="#platform-browser-target-es6" aria-label="Permalink to &quot;\`platform: &#39;browser\`, \`target: &#39;es6&#39;\`&quot;">​</a></h3><p>Tell <code>esbuild</code> that we are bundling for the browser, and that we need to compile code down to the ES6 standard, which is the Javascript standard targeted by Source.</p><h3 id="write-false" tabindex="-1"><code>write: false</code> <a class="header-anchor" href="#write-false" aria-label="Permalink to &quot;\`write: false\`&quot;">​</a></h3><p><code>write: false</code> causes <code>esbuild</code> to output its compiled code into memory instead of to disk, which is necessary to finish building the bundle or tab.</p><h2 id="after-esbuild" tabindex="-1">After Esbuild <a class="header-anchor" href="#after-esbuild" aria-label="Permalink to &quot;After Esbuild&quot;">​</a></h2><p>After esbuild bundling, both bundles and tabs are parsed using <a href="https://github.com/acornjs/acorn" target="_blank" rel="noreferrer"><code>acorn</code></a> to produce an AST. Esbuild will produce an IIFE that looks like the following:</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> module </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exports </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {};</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  exports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add_one</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> exports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})();</span></span></code></pre></div><p>The AST is then transformed by the <code>outputBundleOrTab</code> function, which produces output that looks like this:</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> require</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exports </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {};</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  exports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add_one</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> exports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>This is what is finally written to the output folders.</p><p>Consumers of this compiled version of bundles and tabs can retrieve the IIFE by using the default export. When bundles and tabs are loaded, the IIFE is called with a function that simulates the <code>require()</code> function in CommonJS to provide the dependencies marked as external (that have to be provided at runtime).</p><h2 id="js-slang-context" tabindex="-1"><code>js-slang/context</code> <a class="header-anchor" href="#js-slang-context" aria-label="Permalink to &quot;\`js-slang/context\`&quot;">​</a></h2><p><code>js-slang/context</code> is an import provided at runtime by <code>js-slang</code> that returns the context in use for evaluation. It is not an actual import that&#39;s available at compile time, which means that typings have to be provided for it.</p><p>This is achieved using a Typescript declaration file.</p><h2 id="summary-of-build-process" tabindex="-1">Summary of Build Process <a class="header-anchor" href="#summary-of-build-process" aria-label="Permalink to &quot;Summary of Build Process&quot;">​</a></h2>`,41)),(i(),p(o,null,{default:a(()=>[d(e,{id:"mermaid-113",class:"mermaid",graph:"graph%20LR%3B%0A%20%20A%5BBundle%20Resolution%5D%0A%20%20B%5BEsbuild%20Bundling%5D%0A%20%20C%5BAST%20Manipulation%5D%0A%20%20D%5BWrite%20to%20Output%5D%0A%0A%20%20A%20--%3E%20B%20--%3E%20C%20--%3E%20D%0A"})]),fallback:a(()=>s[0]||(s[0]=[r(" Loading... ")])),_:1}))])}const F=n(k,[["render",c]]);export{f as __pageData,F as default};
